---
import Button from "@/components/Button.astro";
import Heading from "@/components/Hero/Heading.astro";
import MinimalPrice from "@/components/Products/MinimalPrice.astro";
import rawProducts from "@/components/Products/product.json" assert { type: "json" };
import type { ProductType } from "@/components/Products/types";
import CloseButton from "@/components/Tarif/Dialog/CloseButton.astro";
import Dialog from "@/components/Tarif/Dialog/Dialog.astro";
import Checkboxes from "@/components/Tarif/Form/Checkboxes.astro";
import Form from "@/components/Tarif/Form/Form.astro";
import FormHeading from "@/components/Tarif/Form/FormHeading.astro";
import Inputs from "@/components/Tarif/Form/Inputs.astro";
import Message from "@/components/Tarif/Form/Message.astro";
import rawOptions from "@/components/Tarif/Form/option.json" assert { type: "json" };
import Pictures from "@/components/Tarif/Pictures.astro";
import Stats from "@/components/Tarif/Stats.astro";
import TarifText from "@/components/Tarif/TarifText.astro";
import type { OptionType } from "@/components/Tarif/types";
import HeaderFooter from "@/layouts/HeaderFooter.astro";
import Section from "@/layouts/Section.astro";
import { ArrowDown, type LucideProps } from "lucide-react";
import type { ForwardRefExoticComponent, RefAttributes } from "react";
import Layout from "../layouts/Layout.astro";

const options = rawOptions.options as OptionType[];
const products = rawProducts.products as ProductType[];

type StatsComponent = {
  label: string;
  type: "none" | "bar" | "badge";
  Icon?: ForwardRefExoticComponent<Omit<LucideProps, "ref"> & RefAttributes<SVGSVGElement>>;
  productKey: keyof ProductType;
};
const statsComponents: StatsComponent[] = [
  // , Icon: Hourglass
  // , Icon: Gauge
  // , Icon: Backpack
  // , Icon: MapPin
  // , Icon: MapPin
  { label: "duration", type: "none", productKey: "duration" },
  { label: "dificulty", type: "bar", productKey: "stats" },
  { label: "mat√©riels", type: "badge", productKey: "materials" },
  { label: "lieux", type: "badge", productKey: "locations" },
  { label: "public", type: "none", productKey: "public" },
];
---

<script>
  // import { setupIntersectionObserver } from "@/lib/utils";
  document.addEventListener("astro:page-load", () => {
    const getThem = <T extends HTMLElement>(s: string) => Array.from(document.querySelectorAll(s) as unknown as T[]);

    getThem<HTMLDialogElement>("dialog").forEach((dialog) => {
      const action = dialog.dataset.action as string;
      const key = action.split("#")[1];

      const openBtn = document.querySelector(`[data-action='open#${key}']`) as HTMLButtonElement;
      const closeBtns = getThem<HTMLButtonElement>(`[data-action='close#${key}']`);

      if (!openBtn || !closeBtns) console.error(`Missing DOM elements`);

      const close = () => {
        dialog.close();
        document.body.style.overflow = "auto";
      };

      const open = () => {
        dialog.showModal();
        document.body.style.overflow = "hidden";
      };

      openBtn.addEventListener("click", open);
      closeBtns.forEach((btn) => btn.addEventListener("click", close));
    });
  });

  // const intersectionAnchor = document.querySelector("[data-observer]") as HTMLElement;
  // const pictureContainer = document.querySelector("[data-pictures]") as HTMLElement;
  // if (!intersectionAnchor || !pictureContainer)
  //   console.error(`Missing picture container : ${pictureContainer} ; ${intersectionAnchor}`);
  // const initialPosition = pictureContainer.getBoundingClientRect().y;
  // console.log("initialPosition : ", initialPosition);

  // const onIntersect = () => {
  //   document.addEventListener("scroll", () => {
  //     const newPosition = window.scrollY - initialPosition + 200;
  //     pictureContainer.style.top = `${newPosition}px`;
  //   });
  // };

  // const onDisappear = () => console.log("intersectionAnchor not intersecting");
  // setupIntersectionObserver({
  //   element: intersectionAnchor,
  //   debugLog: "intersectionAnchor",
  //   onIntersect,
  //   onDisappear,
  // });
  // Step 1: Get ALL elements on the page
</script>

<!-- <style>
  .picture-container {
    display: grid;
    grid-template-areas: "area";
  }

  .sticky-area {
    grid-area: area;
  }
</style> -->
<Layout title="tarif">
  <HeaderFooter slot="header" />
  <Section>
    <Heading h2="Nos tarifs" h3="Composable et personalisable">
      <div class="grow max-h-[10%]"></div>
      <ArrowDown size="32" />
    </Heading>
  </Section>

  <!-- <div class={`relative`}>
    <div class="absolute w-screen h-screen ring-1 ring-yellow-500 -top-[25vh]" data-observer></div> w-[500px] h-[500px] w-full h-[500px] 
  </div> -->
  <Section className={"grid grid-cols-2 items-start container gap-y-72 gap-x-20"}>
    <div class="full flex vertical" style="align-items:flex-start;">
      <div class={`absolute picture-container h-full`} data-pictures={products.length}>
        <div class={`sticky bg-red-500 h-20 w-20`}></div>
        {
          products.map((_, i) => {
            return (
              <>
                {/* <section class="sticky-area" data-index={`${i + 1}`}> */}
                {/* <Pictures size={500} /> */}
                {/* </section> */}
              </>
            );
          })
        }
      </div>
    </div>
    <div>
      {
        products.map((product) => {
          return (
            <section class="vertical max-h-[600px] gap-7 items-start justify-evenly mb-80">
              <TarifText title={product.title} description={product.description.long} />
              <div class="grid grid-cols-2">
                <div class="vertical gap-1">
                  {statsComponents.map((stat) => {
                    const { label, type, Icon, productKey } = stat;
                    return (
                      <Stats label={label} type={type} stats={product[productKey]}>
                        {Icon && <Icon slot="icon" />}
                      </Stats>
                    );
                  })}
                </div>
                <div class="grid items-start justify-end">
                  <ul class="w-full">
                    <p class="font-semibold mb-2">Au programme :</p>
                    {product.tasks.map((task) => (
                      <li class="w-full horizontal items-center gap-3 mb-1">
                        {/* <CircleChevronRight className="stroke-1 h-4 w-4" /> */}
                        <p class="full">{task}</p>
                      </li>
                    ))}
                  </ul>
                </div>
              </div>
              <Dialog product={product}>
                <>
                  <CloseButton key={product.id} />
                  <Form key={product.id} id={product.id}>
                    <FormHeading product={product} />
                    <Inputs product={product} />
                    <Checkboxes options={options} key={product.id} />
                    <Message product={product} />
                  </Form>
                </>
              </Dialog>
              <div class="horizontal center gap-5">
                <Button data-action={`open#${product.id}`} dark size="lg" ring="sm">
                  S'inscrire
                </Button>
                <MinimalPrice price={product.price} unit={product.unit} />
              </div>
            </section>
          );
        })
      }
    </div>
  </Section>

  <HeaderFooter slot="footer" as="footer" className="mt-32" />
</Layout>
